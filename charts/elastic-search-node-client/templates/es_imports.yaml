apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "elastic-search-node-client.fullname" . }}-imports
  labels:
{{ include "elastic-search-node-client.labels" . | indent 4 }}
spec:
  # Yes this is ridiculous, but we need to REALLY try hard to get this into the cluster
  backoffLimit: 25
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "elastic-search-node-client.name" . }}-imports
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
    {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
    {{- end }}
      serviceAccountName: {{ template "elastic-search-node-client.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      restartPolicy: OnFailure
      {{ $kibanaUrl := .Values.kibana_url }}
      {{ with .Values.elasticsearch_load }}
      containers:
      - name: elasticdump-imports
        image: {{ .image }}
        imagePullPolicy: {{ $.Values.image.pullPolicy }}
        command:
          - /bin/sh
          - -exc
          # language=sh
          - |
            # yes, even 10 minutes may not be enough for ES to be a-ok
            # and realistically we want this to wait forever, but we'll start here
            for _ in $(seq 1 60); do
              if wget --quiet -O /dev/null -T 1 {{ .url }}/_cat/health >/dev/null 2>&1; then
                break
              fi
              sleep 10
            done
            wget https://{{ .bucketname }}.s3.amazonaws.com/{{ .keyprefix }}/configtemplate.json

            elasticdump \
              --input=./configtemplate.json \
              --output={{ .url }}/configservice \
              --type=template

            demodb="$(wget --quiet -O - http://account-management.ui.svc.cluster.local/api/server/settings/demodb)"
            if [ "$demodb" != "false" ]; then
              wget https://{{ .bucketname }}.s3.amazonaws.com/{{ .keyprefix }}/demodb.json
              elasticdump \
                --input=./demodb.json \
                --output={{ .url }}/ \
                --type=data

              # Explicitly waiting until after the elasticdump to do this work as it is not as critical as the above
              # Add the aliases needed for the index pattern in kibana
              apk add curl
              curl -X PUT -fsSL '{{ .url }}/aws*/_alias/or_assets'
              curl -X PUT -fsSL '{{ .url }}/aws*/_alias/or_assets_first_added'
              curl -X PUT -fsSL '{{ .url }}/aws*/_alias/or_assets_last_updated'

              out_fn=dashboards.ndjson
              curl -fsSLo ${out_fn} https://{{ .bucketname }}.s3.amazonaws.com/{{ .keyprefix }}/$out_fn
              for _ in 1 2 3 4 5 6 7 8 9 10; do
                if curl -fsSL -H "kbn-xsrf: true" \
                       --form "file=@${out_fn}" \
                      "{{ $kibanaUrl }}/api/saved_objects/_import?overwrite=true"
                then
                  break
                fi
                sleep 30 # 10 seconds wasnt enough
              done
            fi
      {{ end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
    {{- end }}
    {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
    {{- end }}
